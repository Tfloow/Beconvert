{% extends "base.html" %}

{% block head %}
<title>{{ _("Invoice - Under Construction") }}</title>
{% endblock %}

{% block content %}

{% if warning %}
    <div id="errorRibbon" 
        class="bg-red-600 text-white text-center py-2 px-4 rounded-md mb-4">
        {{ _('You must upload a file before converting') }}
    </div>
{% endif %}

{% if error %}
    <div id="warningRibbon" 
        class="bg-yellow-600 text-white text-center py-2 px-4 rounded-md mb-4">
        <b>{{ _('Error or Unsupported conversion.') }}</b> 
        <p>{{ _('Please check the supported conversions in the guide.') }}</p>
    </div>
{% endif %}

    <!-- Container with two forms side by side -->
    <div class="bg-white p-8 rounded-lg shadow-md border border-gray-200 mb-10 flex flex-col sm:flex-row justify-between gap-6">

        <!-- Upload Form -->
        <form id="uploadForm" action="/invoice/create" method="post" enctype="multipart/form-data"
                class="flex flex-col sm:flex-row items-center gap-4">
            <input id="fileInput" type="file" name="file"
                accept=".csv,.txt,.xlsx,.md,.yaml,.yml"
                class="border rounded-md px-3 py-2 w-full sm:w-auto focus:outline-none focus:ring-2 focus:ring-blue-500">
            <button id="convert-btn" type="submit"
                    class="relative flex items-center justify-center bg-blue-600 text-white px-6 py-3 rounded-lg font-bold shadow-md hover:bg-blue-700 transition disabled:opacity-70 disabled:cursor-not-allowed">
                <span id="convert-text">{{ _('Create an invoice') }}</span>
                <!-- Hidden spinner -->
                <svg id="convert-spinner" class="animate-spin h-5 w-5 ml-2 hidden text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
                </svg>
            </button>
        </form>
        
        <div>
            <!-- Secret Key Form -->
            <form id="keyForm" class="flex items-center gap-3">
                <input type="password" id="secretKey" placeholder="Enter pro key"
                    class="border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 
                        {% if PRO_ACCESS %} bg-gray-100 text-gray-400 cursor-not-allowed {% endif %}"
                    {% if PRO_ACCESS %} disabled {% endif %}>
                <button type="submit"
                    class="bg-green-600 text-white px-4 py-2 rounded-lg font-bold shadow-md hover:bg-green-700 transition
                        {% if PRO_ACCESS %} opacity-50 cursor-not-allowed hover:bg-green-600 {% endif %}"
                    {% if PRO_ACCESS %} disabled {% endif %}>
                    {% if PRO_ACCESS %} Already Premium {% else %} Save Key {% endif %}
                </button>
            </form>


            <!-- Premium Output Selection (below the premium form) -->
            <div class="mt-4">
                <form id="outputForm" class="flex items-center gap-3">
                    <label for="outputType" class="font-bold text-gray-700 {% if not PRO_ACCESS %} opacity-50 cursor-not-allowed {% endif %}">Output Type:</label>
                    <select id="outputType" name="outputType" 
                        class="border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 {% if not PRO_ACCESS %} bg-gray-100 text-gray-400 cursor-not-allowed {% endif %}" {% if not PRO_ACCESS %} disabled {% endif %}>
                        {% for t in SupportedOutputFileTypes.keys() %}
                            <option value="{{t}}" {% if t == FILE_OUT %}selected{% endif %}>{{t}}</option>
                        {% endfor %}
                    </select>
                    <!--<button type="submit"
                        class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold shadow-md hover:bg-blue-700 transition  {% if not PRO_ACCESS %} opacity-50 cursor-not-allowed {% endif %}" {% if not PRO_ACCESS %} disabled {% endif %}>
                            {% if PRO_ACCESS %} Save {% else %} ðŸ”‘ - Locked {% endif %}
                    </button>-->
                </form>
            </div>
        </div>


    </div>


<!-- PDF Preview -->
{% if ID %}
    <div class="flex justify-center">
        <iframe 
            src="{{ url_for('uploaded_file', ID=ID, filename='output'+file_out_type) }}" 
            width="100%" 
            height="500" 
            class="border rounded-lg shadow-lg"
        ></iframe>
    </div>
{% else %}
    <div class="flex justify-center">
        <div class="w-full h-60 flex items-center justify-center border-2 border-dashed rounded-lg shadow-sm bg-gray-50 text-gray-500">
            <p class="text-lg font-medium">Your invoice will appear here after creation</p>
        </div>
    </div>
{% endif %}


 <!-- How it Works Section -->
    <section class="py-20 bg-white">
        <div class="max-w-4xl mx-auto px-4 text-center">
            <h2 class="text-3xl font-extrabold mb-12">{{ _("How it Works") }}</h2>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-8">
                <div class="p-6 border rounded-lg hover:shadow-lg transition">
                    <span class="text-4xl mb-4 block">ðŸ“„</span>
                    <h3 class="font-bold mb-2">{{ _("Select") }}</h3>
                    <p>{{ _("Upload your invoice spreadsheet or a text file with a table.") }}</p>
                </div>
                <div class="p-6 border rounded-lg hover:shadow-lg transition">
                    <span class="text-4xl mb-4 block">âš¡</span>
                    <h3 class="font-bold mb-2">{{ _("Convert") }}</h3>
                    <p>{{ _("We will handle the rest and generate your professional invoice in DIN 5008 format.") }}</p>
                </div>
                <div class="p-6 border rounded-lg hover:shadow-lg transition">
                    <span class="text-4xl mb-4 block">ðŸŽ‰</span>
                    <h3 class="font-bold mb-2">{{ _("Download") }}</h3>
                    <p>{{ _("Download your PDF invoice. Premium users can obtain a Word, Excel, Latex, ... version") }}</p>
                </div>
            </div>
        </div>
    </section>

{% endblock %}

{% block script %}
<script>
  document.getElementById("convert-btn").addEventListener("click", function () {
    const btn = this;
    const text = document.getElementById("convert-text");
    const spinner = document.getElementById("convert-spinner");

    // Disable button and show spinner
    //btn.disabled = true;
    text.textContent = "{{ _('Converting...') }}"; // optional
    spinner.classList.remove("hidden");
  });
</script>

<script>
document.getElementById("keyForm").addEventListener("submit", function(e) {
    e.preventDefault();
    const key = document.getElementById("secretKey").value;

    if (key.trim() !== "") {
        // Save as cookie for 7 days
        document.cookie = "PRO_KEY=" + encodeURIComponent(key) + "; path=/; max-age=" + 60*60*24*7;
        window.location.reload();
    }
});
</script>

<script>
      // Cookie helpers
  function setCookie(name, value, days = 30) {
    const d = new Date();
    d.setTime(d.getTime() + (days*24*60*60*1000));
    const expires = "expires="+ d.toUTCString();
    document.cookie = name + "=" + encodeURIComponent(value) + ";" + expires + ";path=/";
  }

  function getCookie(name) {
    const cname = name + "=";
    const decoded = decodeURIComponent(document.cookie);
    const ca = decoded.split(';');
    for(let c of ca) {
      c = c.trim();
      if (c.indexOf(cname) === 0) return c.substring(cname.length, c.length);
    }
    return "";
  }

  const outputSel = document.getElementById("outputType");


  function update() {
    const outType = outputSel.value;

    setCookie("output_type_invoice", outType);
    }

    // Load saved cookies on page load
  window.addEventListener("DOMContentLoaded", () => {
    const savedOut = getCookie("output_type_invoice");

    if (savedOut && outputSel.querySelector(`option[value="${savedOut}"]`)) {
      outputSel.value = savedOut;
    }
    update();
  });

  outputSel.addEventListener("change", update);
</script>
{% endblock %}
